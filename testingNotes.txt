The first task is to correctly select rules based on selectors and criteria.
For each medication for this patient, we want to select the rules that apply.
We can assume that the data will load all at once from the EHR, so as soon as the data is fully loaded we start processing rules.
It is possible that we will get new data about the same patient, so it is probably good to use a SELECT ... ORDER BY date_retrieved LIMIT 1;

The general format of the rules is:
(selector_or & NOT (selector_not))
&
(condition_problem OR condition_age OR condition_drug OR condition_lab OR condition_allergy)

The list of drugs in selector_or is joined with or, the list of drugs in selector_not is joined with AND NOT.

The only exception to this format is rule 19 and 19a, which have a condition_problem & condition_drug. I've designated this by starting the condition_drug block with an & .

Condition_problem has boolean logic (ands and ors).
Condition.drug can contain a list of drugs or medication.startDate. A comma-sepaarated list of drugs is joined with OR, ! and &! indicate that it should be joined with NOT and AND NOT.
Condition_age and condition_lab can have < and > .
Condition_lab can have a value or a date or both. ! indicates that the value is missing (i.e. there is no natrium value for this patient).
If we are lucky, if an allergy is a drug allergy we will get an ATC code for the class or classes of drugs that the patient is allergic to. If they are allergic to THIS drug then condition_allergy = true. I suspect allergies are free text, though, so this is low priority.





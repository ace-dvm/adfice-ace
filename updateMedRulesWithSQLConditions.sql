alter table med_rules add column sql_condition varchar(1000);
/*
Note on date comparison: 
date_measured BEFORE target (i.e. old) = date_measured <= (CURRENT_DATE() - INTERVAL 11 MONTH) limit 1;
date_measured AFTER target (i.e. recent) = date_measured >= (CURRENT_DATE() - INTERVAL 11 MONTH) limit 1;
*/
UPDATE med_rules SET sql_condition = "select true from patient_problems where \'angststoornis\' in (select name from patient_problems where patient_id = ?) and !(\'epilepsy\' in (select name from patient_problems where patient_id = ?)) limit 1;" where medication_criteria_id = "6";
UPDATE med_rules SET sql_condition = "select true from patient_problems where patient_id = ? and name = \'epilepsy\' limit 1;" where medication_criteria_id = "6a";
UPDATE med_rules SET sql_condition = "select true where (select patient_id from patient_problems where patient_id = ? and name IN(\'angststoornis\',\'epilepsy\') limit 1) IS NULL;" where medication_criteria_id = "6b";
UPDATE med_rules SET sql_condition = "select true from (select name from patient_problems where patient_id = ? and name in(\'parkinson\',\'lewy-bodies-dementia\',\'multiple-system-atrophy\',\'progressive-supranuclear-palsy\')) as p;" where medication_criteria_id = "9";
UPDATE med_rules SET sql_condition = "select true from (select ATC_code from patient_medications where patient_id = ? and ATC_code in(\'J02AB02\',\'J02AC04\',\'J02AC03\',\'J02AC02\',\'J01FA09\',\'V03AX03\',\'J05AE03\',\'J05AE01\',\'J05AR10\')) as p;" where medication_criteria_id = "10";
UPDATE med_rules SET sql_condition = "select true from (select name from patient_problems where patient_id = ? and name in(\'delier\',\'dementia\')) as p;" where medication_criteria_id = "14";
UPDATE med_rules SET sql_condition = "select true where (select true from patient_problems where patient_id = ? and name in(\'parkinson\',\'lewy-bodies-dementia\',\'multiple-system-atrophy\',\'progressive-supranuclear-palsy\') limit 1) IS NULL and (select true from patient_problems where patient_id = ? and name = \'delier\' limit 1);" where medication_criteria_id = "14a";
UPDATE med_rules SET sql_condition = "select true from (select (select true from patient_problems where patient_id = ? and name = \'dementie\') as d from patient_problems limit 1) as dd JOIN (select (select (select true from (select name from patient_problems where patient_id = ? and name in(\'parkinson\',\'lewy-bodies-dementia\',\'multiple-system-atrophy\',\'progressive-supranuclear-palsy\')) as p) IS NULL limit 1) as e) as ee on d = e;" where medication_criteria_id = "14b";
UPDATE med_rules SET sql_condition = "select true from patient_problems where patient_id = ? and name = \'schizofrenie\' limit 1;" where medication_criteria_id = "14c";
UPDATE med_rules SET sql_condition = "select true from patient_problems where !(\'delier\' in (select name from patient_problems where patient_id = ?)) and !(\'dementie\' in (select name from patient_problems where patient_id = ?))  and !(\'schizofrenie\' in (select name from patient_problems where patient_id = ?)) limit 1;" where medication_criteria_id = "14d";
UPDATE med_rules SET sql_condition = "select true from (select name from patient_problems where patient_id = ? and name in(\'parkinson\',\'lewy-bodies-dementia\',\'multiple-system-atrophy\',\'progressive-supranuclear-palsy\')) as p;" where medication_criteria_id = "15";
UPDATE med_rules SET sql_condition = "select true from patient_problems where (select true from patient_problems where patient_id = ? and name = \'depressie\' limit 1) and (select true from patient_medications where patient_id = ? and ATC_code like \'N06A%\' and start_date > CURRENT_DATE() - INTERVAL 6 MONTH );" where medication_criteria_id = "19";
UPDATE med_rules SET sql_condition = "select true from patient_problems where (select true from patient_problems where patient_id = ? and name = \'depressie\' limit 1) and (select true from patient_medications where patient_id = ? and ATC_code like \'N06A%\' and start_date <= CURRENT_DATE() - INTERVAL 6 MONTH );" where medication_criteria_id = "19a";
UPDATE med_rules SET sql_condition = "select true from patient_problems where \'angststoornis\' in (select name from patient_problems where patient_id = ?) and !(\'depressie\' in (select name from patient_problems where patient_id = ?)) limit 1;" where medication_criteria_id = "19b";
UPDATE med_rules SET sql_condition = "select true from patient_problems where !(\'angststoornis\' in (select name from patient_problems where patient_id = ?)) and !(\'depressie\' in (select name from patient_problems where patient_id = ?)) limit 1;" where medication_criteria_id = "19c";
UPDATE med_rules SET sql_condition = "select true from patient where id = ? and age < 80 limit 1;" where medication_criteria_id = "21";
UPDATE med_rules SET sql_condition = "select true from patient where id = ? and age >= 80 limit 1;" where medication_criteria_id = "22";
UPDATE med_rules SET sql_condition = "select true from patient_labs where (select patient_id from patient_labs where patient_id = ? and lab_test_name = \'natrium\') IS NULL limit 1;" where medication_criteria_id = "23";
UPDATE med_rules SET sql_condition = "select true from patient_labs where patient_id = ? AND lab_test_name = \'natrium\' AND date_measured <= (CURRENT_DATE() - INTERVAL 11 MONTH) limit 1;" where medication_criteria_id = "24";
UPDATE med_rules SET sql_condition = "select true from (select patient_labs.patient_id, lab_test_name, lab_test_result, name from patient_labs LEFT OUTER JOIN patient_problems on patient_labs.patient_id = patient_problems.patient_id where patient_labs.patient_id = ? AND lab_test_name = \'natrium\' AND cast(lab_test_result as decimal(5,2)) < 135 UNION select patient_problems.patient_id, lab_test_name, lab_test_result, name from patient_problems LEFT OUTER JOIN patient_labs on patient_labs.patient_id = patient_problems.patient_id where patient_problems.patient_id = ? and name in(\'hyponatremia\',\'orthostatische-hypotensie\',\'tachycardia\',\'arrhythmia\')) as lp;" where medication_criteria_id = "25";
UPDATE med_rules SET sql_condition = "select true from patient_problems where patient_id = ? and name in(\'parkinson\',\'lewy-bodies-dementia\',\'multiple-system-atrophy\',\'progressive-supranuclear-palsy\') limit 1;" where medication_criteria_id = "26";
UPDATE med_rules SET sql_condition = "select true where (select true from patient_problems where patient_id = ? and name in(\'parkinson\',\'lewy-bodies-dementia\',\'multiple-system-atrophy\',\'progressive-supranuclear-palsy\') limit 1) and (select true from patient_problems where patient_id = ? and name = \'orthostatische-hypotensie\' limit 1);" where medication_criteria_id = "26a";
UPDATE med_rules SET sql_condition = "select true where (select true from (select name from patient_problems where patient_id = ? and name in(\'parkinson\',\'lewy-bodies-dementia\',\'multiple-system-atrophy\',\'progressive-supranuclear-palsy\')) as p) IS NULL;" where medication_criteria_id = "26b";
UPDATE med_rules SET sql_condition = "select true where (select true from (select ATC_code from patient_medications where patient_id = ? and ATC_code LIKE \'C09%\') as p) IS NULL;" where medication_criteria_id = "35";
UPDATE med_rules SET sql_condition = "select true from patient_problems where patient_id = ? and name = \'hartfalen\' limit 1;" where medication_criteria_id = "36";
UPDATE med_rules SET sql_condition = "select true from patient_problems where patient_id = ? and name = \'hartfalen\' limit 1;" where medication_criteria_id = "37";
UPDATE med_rules SET sql_condition = "select true from patient_problems where \'hypertensie\' in (select name from patient_problems where patient_id = ?) and !(\'hartfalen\' in (select name from patient_problems where patient_id = ?)) limit 1;" where medication_criteria_id = "38";
UPDATE med_rules SET sql_condition = "select true from patient_problems where (select true from patient_problems where patient_id = ? and name = \'hypokalemia\' limit 1) or (select true from patient_labs where patient_labs.patient_id = ? AND lab_test_name = \'kalium\' AND cast(lab_test_result as decimal(5,2)) < 3.0  limit 1) limit 1;" where medication_criteria_id = "40";
UPDATE med_rules SET sql_condition = "select true from patient_problems where (select true from patient_problems where patient_id = ? and name = \'hyponatremia\' limit 1) or  (select true from patient_labs where patient_labs.patient_id = ? and name = \'natrium\' and lab_test_result < 130 limit 1);" where medication_criteria_id = "40a";
UPDATE med_rules SET sql_condition = "select true where (select patient_id from patient_problems where patient_id = ? and name IN(\'hartfalen\',\'hypertensie\') limit 1) IS NULL;" where medication_criteria_id = "41";
UPDATE med_rules SET sql_condition = "select true from patient_problems where (select true from patient_problems where patient_id = ? and name = \'hypercalcemia\' limit 1) or (select true from patient_labs where patient_labs.patient_id = ? AND lab_test_name = \'calcium\' AND cast(lab_test_result as decimal(5,2)) > 2.65  limit 1) limit 1;" where medication_criteria_id = "40b";
UPDATE med_rules SET sql_condition = "select true from patient_problems where patient_id = ? and name = \'jicht\' limit 1;" where medication_criteria_id = "40c";
UPDATE med_rules SET sql_condition = "select true from ((select patient_id, name as pn from patient_problems where patient_id = ? and name in(\'parkinson\',\'lewy-bodies-dementia\',\'multiple-system-atrophy\',\'progressive-supranuclear-palsy\')) as ppn join (select patient_id, name as po from patient_problems where patient_id = ? and name in(\'orthostatische-hypotensie\')) as ppo on ppn.patient_id = ppo.patient_id) where pn IS NOT NULL and po IS NOT NULL;" where medication_criteria_id = "48";
UPDATE med_rules SET sql_condition = "select true from patient_problems where patient_id = ? and name = \'hypertensie\' limit 1;" where medication_criteria_id = "52";
UPDATE med_rules SET sql_condition = "select true where (select true from patient_problems where patient_id = ? and name = \'hypertensie\' limit 1) IS NULL;" where medication_criteria_id = "53";
UPDATE med_rules SET sql_condition = "select true from patient_problems where patient_id = ? and name = \'diabetes\' limit 1;" where medication_criteria_id = "57a";
UPDATE med_rules SET sql_condition = "select true from patient_problems where (select true from patient_problems where patient_id = ? and name = \'atriumfibrilleren\' limit 1) IS NULL and (select true from patient_problems where patient_id = ? and name = \'angina-pectoris\' limit 1) IS NULL  and (select true from patient_problems where patient_id = ? and name = \'myocardinfarct\' limit 1) IS NULL limit 1;" where medication_criteria_id = "58";
UPDATE med_rules SET sql_condition = "select true from patient_problems where patient_id = ? and name IN(\'atriumfibrilleren\',\'angina-pectoris\',\'myocardinfarct\') limit 1;" where medication_criteria_id = "59";
UPDATE med_rules SET sql_condition = "select true from patient_labs where patient_labs.patient_id = ? AND lab_test_name = \'eGFR\' AND cast(lab_test_result as decimal(5,2)) > 30 AND date_measured >= CURRENT_DATE() - INTERVAL 11 MONTH limit 1;" where medication_criteria_id = "68";
UPDATE med_rules SET sql_condition = "select true from patient_labs where patient_labs.patient_id = ? AND lab_test_name = \'eGFR\' AND cast(lab_test_result as decimal(5,2)) <= 30 AND date_measured >= CURRENT_DATE() - INTERVAL 11 MONTH limit 1;" where medication_criteria_id = "69";
UPDATE med_rules SET sql_condition = "select true from patient_labs where (select patient_id from patient_labs where patient_id = ? and lab_test_name = \'eGFR\') IS NULL limit 1;" where medication_criteria_id = "70";
UPDATE med_rules SET sql_condition = "select true from patient_labs where patient_labs.patient_id = ? AND lab_test_name = \'eGFR\' AND date_measured < CURRENT_DATE() - INTERVAL 11 MONTH limit 1;" where medication_criteria_id = "71";
UPDATE med_rules SET sql_condition = "select true from patient_labs where patient_labs.patient_id = ? AND lab_test_name = \'eGFR\' AND cast(lab_test_result as decimal(5,2)) > 30 AND date_measured >= CURRENT_DATE() - INTERVAL 11 MONTH limit 1;" where medication_criteria_id = "79";
UPDATE med_rules SET sql_condition = "select true from patient_labs where patient_labs.patient_id = ? AND lab_test_name = \'eGFR\' AND cast(lab_test_result as decimal(5,2)) <= 30 AND date_measured >= CURRENT_DATE() - INTERVAL 11 MONTH limit 1;" where medication_criteria_id = "80";
UPDATE med_rules SET sql_condition = "select true where (select true from patient_labs where patient_labs.patient_id = ? AND lab_test_name = \'eGFR\' AND cast(lab_test_result as decimal(5,2)) <= 30) IS NULL;" where medication_criteria_id = "80a";
UPDATE med_rules SET sql_condition = "select true where (select true from patient_labs where patient_labs.patient_id = ? AND lab_test_name = \'eGFR\' AND cast(lab_test_result as decimal(5,2)) <= 30) IS NULL;" where medication_criteria_id = "80b";
UPDATE med_rules SET sql_condition = "select true from patient_labs where (select patient_id from patient_labs where patient_id = ? and lab_test_name = \'eGFR\') IS NULL limit 1;" where medication_criteria_id = "81";
UPDATE med_rules SET sql_condition = "select true from patient_labs where patient_labs.patient_id = ? AND lab_test_name = \'eGFR\' AND date_measured < CURRENT_DATE() - INTERVAL 11 MONTH limit 1;" where medication_criteria_id = "82";
UPDATE med_rules SET sql_condition = "select true from patient_medications where patient_id = ? and ATC_code in(\'N02BE01\',\'N02BE51\',\'N02BE71\',\'N02AJ01\',\'N02AJ06\',\'N02AJ13\',\'N02AJ17\') limit 1;" where medication_criteria_id = "83";
UPDATE med_rules SET sql_condition = "select true from patient_problems where patient_id = ? and name IN(\'paraplegia\',\'dwaarslaesie\') limit 1;" where medication_criteria_id = "86";
UPDATE med_rules SET sql_condition = "select true from patient_problems where (select true from patient_problems where patient_id = ? and name = \'paraplegia\' limit 1) IS NULL  and (select true from patient_problems where patient_id = ? and name = \'dwaarslaesie\' limit 1) IS NULL limit 1;" where medication_criteria_id = "87";
UPDATE med_rules SET sql_condition = "select true from patient_labs where patient_labs.patient_id = ? AND lab_test_name = \'eGFR\' AND cast(lab_test_result as decimal(5,2)) > 30 AND date_measured >= CURRENT_DATE() - INTERVAL 11 MONTH limit 1;" where medication_criteria_id = "89";
UPDATE med_rules SET sql_condition = "select true from patient_labs where patient_labs.patient_id = ? AND lab_test_name = \'eGFR\' AND cast(lab_test_result as decimal(5,2)) <= 30 AND date_measured >= CURRENT_DATE() - INTERVAL 11 MONTH limit 1;" where medication_criteria_id = "90";
UPDATE med_rules SET sql_condition = "select true from patient_labs where (select patient_id from patient_labs where patient_id = ? and lab_test_name = \'eGFR\') IS NULL limit 1;" where medication_criteria_id = "91";
UPDATE med_rules SET sql_condition = "select true from patient_labs where patient_labs.patient_id = ? AND lab_test_name = \'eGFR\' AND date_measured < CURRENT_DATE() - INTERVAL 11 MONTH limit 1;" where medication_criteria_id = "92";
UPDATE med_rules SET sql_condition = "select true from patient_problems where patient_id = ? and name in(\'parkinson\',\'lewy-bodies-dementia\',\'multiple-system-atrophy\',\'progressive-supranuclear-palsy\') is not null;" where medication_criteria_id = "102";
UPDATE med_rules SET sql_condition = "select true where (select true from patient_problems where patient_id = ? and name = \'angststoornis\' limit 1) IS NULL;" where medication_criteria_id = "12";
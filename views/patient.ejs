<!DOCTYPE html>
<!-- SPDX-License-Identifier: GPL-3.0-or-later -->
<!-- Copyright (C) 2021 S. K. Medlock, E. K. Herman, K. M. Shaw -->
<%# see https://ejs.co/#docs -%>
<% function ucfirst(s) { if (typeof s !== 'string') { return s; } return s.charAt(0).toUpperCase() + s.slice(1); } -%>
<html lang="<%= lang %>">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patient <%= patient_id %></title>
<script src="static/patient.js"></script>
<script>
let patient_id = "<%= patient_id %>";
let viewer_id = "<%= viewer_id %>";
console.log('patient_id: ', patient_id);
</script>
<style>
   * { box-sizing: border-box; }
input { display: inline; }
body {
	font-family: Arial, sans-serif;
}
#footer {
	position: fixed;
	bottom: 0;
	width: 100%;
}
#footer {
	background: #999999;
	line-height: 2;
	text-align: center;
	/* color: #042E64; */
	/* font-size: 30px; */
	font-weight: bold;
	text-shadow: 0 1px 0 #84BAFF;
	box-shadow: 0 0 15px #00214B
}
#patient_info {
	background: #d9d9d9;
	width: 99%;
	padding-top: 5px;
	padding-right: 5px;
	padding-bottom: 5px;
	padding-left: 5px;
}
.advice_no_checkbox {
	border: 2px solid green;
	padding-top: 5px;
	padding-right: 5px;
	padding-bottom: 5px;
	padding-left: 5px;
}
div.prediction{
	margin: auto;
	width: 50%;
}
div.advice_header{
	margin: auto;
	width: 10%;
	font-size: 16px;
	font-weight: bold;
}
div.whitespace{
	height: 3cm;
}
div.refpages{
	display:inline;
	float: right;
}
</style>
</head>
<body>
<form id="patient_form">
<img src="static/Advice_IT_logo_small.png"
     style="max-width: 10%; height: auto;"
     alt="Advice IT logo"
>
<div id="footer">
Patient: <%= patient_id %>
<button id="button_clinician_view" type="button"
        onclick="switch_to_view('clinician')">Voorbereiding</button>
<button id="button_condensed_view" type="button"
        onclick="switch_to_view('condensed')">Consult</button>
<button id="button_patient_view" type="button"
        onclick="switch_to_view('patient')">Advies</button>
<span id="viewer_count"></span>
</div>
<div id=patient_info>
<strong>Pati&euml;ntinformatie:</strong><br/>
Patient: <%= patient_id %><br/>
Leeftijd: <%= patient_advice.age %><br/>
<div class="prediction" id = "prediction">
<p>Kans om te vallen binnen 12 maanden: <span style="color: red;">70%</span> (lees meer over het predictiemodel)</p>
<img src="static/riskScale70.png" alt="risk:70%">
</div>
<%     let meds = patient_advice.medications; -%>
<span id="patient_medications">
Ga direct naar medicijnen met aanbevolen maatregelen:
<% for (let i = 0; i < meds.length; ++i ) { -%>
<%     let med = meds[i]; -%>
<%     let med_prefix = "med_" + i; -%>
<%     if (i) { -%>
,
<%     } -%>
<%     let med_begin = JSON.stringify(med.start_date).substring(1,11) -%>
<span id="<%= med_prefix %>">
<a href="https://en.wikipedia.org/wiki/ATC_code_<%= med.ATC_code %>"
   title="<%= med.medication_name %> begin: <%= med_begin %>">
<%= ucfirst(med.medication_name).trim() %></a>
<% } -%>
<br/>Medicijnen zonder aanbevolen maatregelen:
<!-- TODO add list of medications where there is no advice
        (list of fired rules is empty)
If there are no medications without advice, show this text:
-->
Geen
</span>
</span>
<span id="patient_problems">
<%     let problems = patient_advice.problems; -%>
<%     if ( problems.length ) { -%>
<br/>
Gedetecteerde relevante problemen:
<% for (let i = 0; i < problems.length; ++i ) { -%>
<%     let problem = problems[i]; -%>
<%     let prob_prefix = "prob_" + i; -%>
<%     if (i) { %>
,
<%     } -%>
<span id="<%= prob_prefix %>">
<span id="<%= prob_prefix %>_from">
<!-- <%= JSON.stringify(problem.start_date).substring(1,11) %> -->
</span>
<span id="<%= prob_prefix %>_name"><%= problem.name %></span><br/>
</span>
<% } -%>
<% } -%>
</span>
<%     let labs = patient_advice.labs; -%>
<span id="patient_labs">
<%     if ( labs.length ) { -%>
Labs:
<%     } -%>
<% for (let i = 0; i < labs.length; ++i ) { -%>
<%     let lab = labs[i]; -%>
<%     let lab_prefix = "lab_" + i; -%>
<%     if (i) { -%>
,
<%     } -%>
<span id="<%= lab_prefix %>">
<span id="<%= lab_prefix %>_name"><%= lab.lab_test_name %></span>:
<span id="<%= lab_prefix %>_result"><%= lab.lab_test_result %></span>
<!--
<span id="<%= lab_prefix %>_date">
        <%= JSON.stringify(lab.date_measured).substring(1,11) %></span>
-->
</span>
<% } -%>
</span>
</div>
<% let medication_advice = patient_advice.medication_advice; -%>
<div id="div_clinician_view" class="div_clinician_view">
<strong>Gezamenlijke besluitvormingsmodel om betrokkenheid te stimuleren</strong>
<img src="static/sharedDecisionMaking.png" style="max-width:100%;" alt="SDM advies">
<div class="advice_header">Medicatiefactoren</div>
<% for (let i = 0; i < medication_advice.length; ++i ) { -%>
<%     let row = medication_advice[i]; -%>
<%     let atc = row.ATC_code; -%>
<a href="https://en.wikipedia.org/wiki/ATC_code_<%= atc %>">
<%= ucfirst(row.medication_name).trim() %></a>
<div class="refpages">Meer informatie over het advies:<!--TODO put refpages here--></div>
<div id="advice_<%= atc %>" class="advice_no_checkbox">
<strong>Advies:</strong>
<%     let advices = row.adviceTextsNoCheckboxes; -%>
<%     for (let j = 0; j < advices.length; ++j ) { -%>
<%         let advice = advices[j]; -%>
<%         let att_prefix = "att_" + i + "_" + j; -%>
<%         let bogus_rule = "NonCB"; -%>
<span id="<%= att_prefix %>_cdss">
<%         for (let k = 0; k < advice.cdss_split.length; ++k) { -%>
<%             let chunk = advice.cdss_split[k]; -%>
<%             let chunk_id = `ft_${atc}_${bogus_rule}_${j}_${k}_e`; -%>
<%             if (chunk.editable) { -%>
<input id="<%= chunk_id %>" type="text"
        value="<%= chunk.text %>"/>
<%             } else { -%>
<span id="<%= chunk_id %>">
<%- md.makeHtml(chunk.text) -%>
</span> <!-- <%= att_prefix %>_cdss_<%= k %>_e -->
<%             } -%>
<%         } -%>
</span> <!-- <%= att_prefix %>_cdss -->
<%     } -%>
</div>
<%     let cb_advices = row.adviceTextsCheckboxes; -%>
<div id="advice_selection_area_<%= i %>" class="advice_selection_area">
<table>
<p>Maatregelen (aangekruist indien aanbevolen):</p>
<%
     for (let j = 0; j < cb_advices.length; ++j ) {
         let cb_advice = cb_advices[j];
         let asa_prefix = "asa_" + i + "_" + j;
         let rulenum = cb_advice.medication_criteria_id;
         let boxnum = cb_advice.selectBoxNum;
         let advice_id_base =`${atc}_${rulenum}_${boxnum}`;
         let checkbox_id = 'cb_' + advice_id_base;
         let row_id = 'tr_' + advice_id_base;
-%>
<span id="<%= asa_prefix %>">
<tr id="<%= row_id %>">
<td>
<span id="<%= asa_prefix %>_sbn">
<input type="checkbox"
        id="<%= checkbox_id %>"
        name="<%= checkbox_id %>"
        value="<%= checkbox_id %>"
        style="visibility:hidden"
/>
</span> <!-- <%= asa_prefix %>_sbn -->
</td>
<td>
<span id="<%= asa_prefix %>_cdss">
<%         for (let k = 0; k < cb_advice.cdss_split.length; ++k) { -%>
<%             let chunk = cb_advice.cdss_split[k]; -%>
<%             let chunk_id = `ft_${atc}_${rulenum}_${boxnum}_${k}_e`; -%>
<%             if (chunk.editable) { -%>
<input id="<%= chunk_id %>" type="text"
        value="<%= chunk.text %>"/>
<%             } else { -%>
<span id="<%= chunk_id %>">
<%- md.makeHtml(chunk.text) -%>
</span> <!-- <%= asa_prefix %>_cdss_<%= k %>_e -->
<%             } -%>
<%         } -%>
</span> <!-- <%= asa_prefix %>_cdss -->
</td>
</tr>
</span> <!-- <%= asa_prefix %> -->
<%     } -%>
</table>
</div><!-- advice_selection_area_<%= i %> -->
<% } -%>
</div><!-- div_clinician_view -->

<div id="div_patient_view" class="div_patient_view">
<% for (let i = 0; i < medication_advice.length; ++i ) { -%>
<%     let row = medication_advice[i]; -%>
<%     let atc = row.ATC_code; -%>
<%     let cb_advices = row.adviceTextsCheckboxes; -%>
<div id="advice_patient_area_<%= i %>" class="advice_patient_area">
<p>Patient:
<%     for (let j = 0; j < cb_advices.length; ++j ) { -%>
<%         let cb_advice = cb_advices[j]; -%>
<%         let apa_prefix = "apa_" + i + "_" + j; -%>
<%         let rulenum = cb_advice.medication_criteria_id; -%>
<%         let boxnum = cb_advice.selectBoxNum; -%>
<%         let checkbox_id = `cb_${atc}_${rulenum}_${boxnum}`; -%>
<% /* TODO only display those items which the clinician has select */ -%>
<span id="<%= apa_prefix %>_patient">
<%         for (let k = 0; k < cb_advice.patient_split.length; ++k) { -%>
<%             let chunk = cb_advice.patient_split[k]; -%>
<%             let chunk_id = `ft_${atc}_${rulenum}_${boxnum}_${k}`; -%>
<%             let chunk_id_e = chunk_id + "_e"; -%>
<%             let chunk_id_p = chunk_id + "_p"; -%>
<% /* TODO replcace editable {{freetext}} with chunk_id_e freetext */ -%>
<%             if (chunk.editable) { -%>
<%- md.makeHtml(chunk.text) -%>
<%             } else { -%>
<%- md.makeHtml(chunk.text) -%>
<%             } -%>
<%         } -%>
</span> <!-- <%= apa_prefix %>_patient -->
<%     } -%>
</div> <!-- advice_patient_area_<%= i %> -->
<% } -%>
</div> <!-- div_patient_view -->

<div id="div_other_med_advice" class="div_other_med_advice">
<p>Andere medicatie-gerelateerde advies:</p><!-- TODO add a free text box where the doctor can type in whatever they want. Like other free text boxes, this should be copied to the Epic and Patient text. -->
<div class="advice_header" style="width:20%">Andere risicofactoren</div>
<!-- TODO add non-med advice -->
<p>Andere advies:</p><!-- TODO add a free text box where the doctor can type in whatever they want. Like other free text boxes, this should be copied to the Epic and Patient text. -->
</div><!-- div_other_med_advice -->

<div id="div_epic_box" class="div_epic_box"><!-- not in patient view -->
<% for (let i = 0; i < medication_advice.length; ++i ) { -%>
<div id="advice_epic_area_<%= i %>" class="advice_epic_area">
<%     let row = medication_advice[i]; -%>
<%     let atc = row.ATC_code; -%>
<%     let cb_advices = row.adviceTextsCheckboxes; -%>
<p>Epic:</p>
<%
     for (let j = 0; j < cb_advices.length; ++j ) {
         let cb_advice = cb_advices[j];
         let aea_prefix = "aea_" + i + "_" + j;
         let rulenum = cb_advice.medication_criteria_id;
         let boxnum = cb_advice.selectBoxNum;
         let advice_id_base =`${atc}_${rulenum}_${boxnum}`;
         let checkbox_id = 'cb_' + advice_id_base;
         let row_id = 'et_' + advice_id_base;
-%>
<% /* TODO only display those items which the clinician has select */ -%>
<span id="<%= row_id %>">
<%         for (let k = 0; k < cb_advice.epic_split.length; ++k) { -%>
<%             let chunk = cb_advice.epic_split[k]; -%>
<%             let chunk_id = `ft_${atc}_${rulenum}_${boxnum}_${k}_e`; -%>
<%             let chunk_id_epic = chunk_id + "pic"; -%>
<% /* TODO replace editable {{freetext}} with chunk_id freetext */ -%>
<%             if (chunk.editable) { -%>
<%- md.makeHtml(chunk.text) -%>
<%             } else { -%>
<%- md.makeHtml(chunk.text) -%>
<%             } -%>
<%         } -%>
</span> <!-- <%= row_id %> -->
<%     } -%>
</div> <!-- advice_epic_area_<%= i %> -->
<% } -%>
</div> <!-- epic_box -->

<div class="whitespace"></div>

</form>
</body>
</html>

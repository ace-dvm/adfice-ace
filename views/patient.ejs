<!DOCTYPE html>
<!-- SPDX-License-Identifier: GPL-3.0-or-later -->
<!-- Copyright (C) 2021 S. K. Medlock, E. K. Herman, K. M. Shaw -->
<%# see https://ejs.co/#docs -%>
<html lang="<%= lang %>">
<head>
<meta charset="UTF-8">
<title>Patient <%= patient_id %></title>
<script src="static/patient.js"></script>
<script>
let patient_id = "<%= patient_id %>";
console.log('patient_id: ', patient_id);
</script>
<style>
#footer {
	position: fixed;
	bottom: 0;
	width: 100%;
}
#footer {
	background: #999999;
	line-height: 2;
	text-align: center;
	/* color: #042E64; */
	/* font-size: 30px; */
	font-family: sans-serif;
	font-weight: bold;
	text-shadow: 0 1px 0 #84BAFF;
	box-shadow: 0 0 15px #00214B
}
#patient_info {
	background: #d9d9d9;
}
.advice_no_checkbox {
	border: 2px solid green;
	padding-top: 5px;
	padding-right: 5px;
	padding-bottom: 5px;
	padding-left: 5px;
}
</style>
</head>
<body>
<div id="footer">
Patient: <%= patient_id %>
<span id="viewer_count"><span/>
</div>
<div id=patient_info>
<strong>Pati&euml;ntinformatie:</strong><br/>
Patient: <%= patient_id %><br/>
Leeftijd: <%= patient_advice.age %><br/>
<%     let meds = patient_advice.medications; -%>
<span id="patient_medications">
medicijnen:
<% for (let i = 0; i < meds.length; ++i ) { -%>
<%     let med = meds[i]; -%>
<%     let med_prefix = "med_" + i; -%>
<%     let med_begin = JSON.stringify(med.start_date).substring(1,11) -%>
<tr id="<%= med_prefix %>">
<a href="https://en.wikipedia.org/wiki/ATC_code_<%= med.ATC_code %>"
   title="<%= med.medication_name %> begin: <%= med_begin %>">
<%= med.medication_name.trim() %></a>
<%     if (i < (meds.length -1) ) { -%>
,
<%     } -%>
<% } -%>
</span>
</div>
<form id="patient_form">
<table id="patient_problems">
<tr><th>probleem</th><th>begin</th></tr>
<%     let problems = patient_advice.problems; -%>
<% for (let i = 0; i < problems.length; ++i ) { -%>
<%     let problem = problems[i]; -%>
<%     let prob_prefix = "prob_" + i; -%>
<tr id="<%= prob_prefix %>">
<td id="<%= prob_prefix %>_name"><%= problem.name %></td>
<td id="<%= prob_prefix %>_from">
	<%= JSON.stringify(problem.start_date).substring(1,11) %></td>
</tr>
<% } -%>
</table>

<%     let labs = patient_advice.labs; -%>
<table id="patient_labs">
<tr><th>naam</th><th>resultaat</th><th>datum</th></tr>
<% for (let i = 0; i < labs.length; ++i ) { -%>
<%     let lab = labs[i]; -%>
<%     let lab_prefix = "lab_" + i; -%>
<tr id="<%= lab_prefix %>">
<td id="<%= lab_prefix %>_name"><%= lab.lab_test_name %></td>
<td id="<%= lab_prefix %>_result"><%= lab.lab_test_result %></td>
<td id="<%= lab_prefix %>_date">
	<%= JSON.stringify(lab.date_measured).substring(1,11) %></td>
</tr>
<% } -%>
</table>


<%     let medication_advice = patient_advice.medication_advice; -%>
<ul>
<% for (let i = 0; i < medication_advice.length; ++i ) { -%>
<%     let row = medication_advice[i]; -%>
<%     let atc = row.ATC_code; -%>
<li><%= row.medication_name %>: <span id="adv_<%= atc %>"><%= atc %></span><br/>
<div id="advice_<%= atc %>" class="advice_no_checkbox">
<strong>Advies:</strong>
<%     let advices = row.adviceTextsNoCheckboxes; -%>
<%     for (let j = 0; j < advices.length; ++j ) { -%>
<%         let advice = advices[j]; -%>
<%           let att_prefix = "att_" + i + "_" + j; -%>
<span id="<%= att_prefix %>">
<span id="<%= advice.medication_criteria_id %>">
<%- md.makeHtml(advice.cdss) %>
</span>
</span>
<%     } -%>
</div>
<table id="adviceTextsCheckboxesTable_<%= i %>">
<tr><th>criterion</th><th>box</th><th>category</th>
<th>cdss</th><th>epic</th><th>patient</th></tr>
<%     let cb_advices = row.adviceTextsCheckboxes; -%>
<%     for (let j = 0; j < cb_advices.length; ++j ) { -%>
<%         let cb_advice = cb_advices[j]; -%>
<%           let atcbt_prefix = "atcbt_" + i + "_" + j; -%>
<%           let rulenum = cb_advice.medication_criteria_id; -%>
<%           let boxnum = cb_advice.selectBoxNum; -%>
<%           let checkbox_id = `cb_${atc}_${rulenum}_${boxnum}`; -%>
<tr id="<%= atcbt_prefix %>">
<td id="<%= atcbt_prefix %>_mc"><%= cb_advice.medication_criteria_id %></td>
<td id="<%= atcbt_prefix %>_sbn">
<input type="checkbox"
	id="<%= checkbox_id %>"
	name="<%= checkbox_id %>"
	value="<%= checkbox_id %>"
	style="visibility:hidden"
/>
</td>
<td id="<%= atcbt_prefix %>_sbc"><%= cb_advice.selectBoxCategory %></td>
<td id="<%= atcbt_prefix %>_cdss"><%- md.makeHtml(cb_advice.cdss) %></td>
<td id="<%= atcbt_prefix %>_epic"><%- md.makeHtml(cb_advice.epic) %></td>
<td id="<%= atcbt_prefix %>_patient"><%- md.makeHtml(cb_advice.patient) %></td>
</tr>
<%     } -%>
</table>
</li>
<% } -%>
</ul>
</form>
</body>
</html>

<!DOCTYPE html>
<!-- SPDX-License-Identifier: GPL-3.0-or-later -->
<!-- Copyright (C) 2021 S. K. Medlock, E. K. Herman, K. M. Shaw -->
<%# see https://ejs.co/#docs -%>
<% function ucfirst(s) { if (typeof s !== 'string') { return s; } return s.charAt(0).toUpperCase() + s.slice(1); } -%>
<html lang="<%= lang %>">
<head>
<meta charset="UTF-8">
<title>Patient <%= patient_id %></title>
<script src="static/patient.js"></script>
<script>
let patient_id = "<%= patient_id %>";
console.log('patient_id: ', patient_id);
</script>
<style>
body {
	font-family: Arial, sans-serif;
}
#footer {
	position: fixed;
	bottom: 0;
	width: 100%;
}
#footer {
	background: #999999;
	line-height: 2;
	text-align: center;
	/* color: #042E64; */
	/* font-size: 30px; */
	font-weight: bold;
	text-shadow: 0 1px 0 #84BAFF;
	box-shadow: 0 0 15px #00214B
}
#patient_info {
	background: #d9d9d9;
	width: 99%;
	padding-top: 5px;
	padding-right: 5px;
	padding-bottom: 5px;
	padding-left: 5px;
}
.advice_no_checkbox {
	border: 2px solid green;
	padding-top: 5px;
	padding-right: 5px;
	padding-bottom: 5px;
	padding-left: 5px;
}
div.prediction{
	margin: auto;
	width: 50%;
}
div.advice_header{
	margin: auto;
	width: 10%;
	font-size: 16px;
	font-weight: bold;
}
div.whitespace{
	height: 3cm;
}
</style>
</head>
<body>
<img src="static/Advice_IT_logo_small.png"
     style="max-width: 10%; height: auto;"
     alt="Advice IT logo"
>
<div id="footer">
Patient: <%= patient_id %>
<span id="viewer_count"></span>
</div>
<div id=patient_info>
<strong>Pati&euml;ntinformatie:</strong><br/>
Patient: <%= patient_id %><br/>
Leeftijd: <%= patient_advice.age %><br/>
<div class="prediction" id = "prediction">
<p>Kans om te vallen binnen 12 maanden: <span style="color: red;">70%</span> (lees meer over het predictiemodel)</p>
<img src="static/riskScale70.png" alt="risk:70%">
</div>
<%     let meds = patient_advice.medications; -%>
<span id="patient_medications">
Ga direct naar medicijnen met aanbevolen maatregelen:
<% for (let i = 0; i < meds.length; ++i ) { -%>
<%     let med = meds[i]; -%>
<%     let med_prefix = "med_" + i; -%>
<%     let med_begin = JSON.stringify(med.start_date).substring(1,11) -%>
<span id="<%= med_prefix %>">
<a href="https://en.wikipedia.org/wiki/ATC_code_<%= med.ATC_code %>"
   title="<%= med.medication_name %> begin: <%= med_begin %>">
<%= ucfirst(med.medication_name).trim() %></a>
<%     if (i < (meds.length -1) ) { -%>
,
<%     } -%>
<% } -%>
<br/>Medicijnen zonder aanbevolen maatregelen:
<!-- TODO add list of medications where there is no advice (list of fired rules is empty) 
If there are no medications without advice, show this text:
-->
Geen
</span>
</span>
<span id="patient_problems">
<%     let problems = patient_advice.problems; -%>
<%     if ( problems.length ) { -%>
<br/>
Gedetecteerde relevante problemen:
<% for (let i = 0; i < problems.length; ++i ) { -%>
<%     let problem = problems[i]; -%>
<%     let prob_prefix = "prob_" + i; -%>
<span id="<%= prob_prefix %>">
<span id="<%= prob_prefix %>_from">
<!-- <%= JSON.stringify(problem.start_date).substring(1,11) %> -->
</span>
<span id="<%= prob_prefix %>_name"><%= problem.name %></span><br/>
</span>
<%     if (i < (problems.length -1) ) { -%>
,
<%     } -%>
<% } -%>
<% } -%>
</span>
</div>

<%     let labs = patient_advice.labs; -%>
<table id="patient_labs">
<tr><th>naam</th><th>resultaat</th><th>datum</th></tr>
<% for (let i = 0; i < labs.length; ++i ) { -%>
<%     let lab = labs[i]; -%>
<%     let lab_prefix = "lab_" + i; -%>
<tr id="<%= lab_prefix %>">
<td id="<%= lab_prefix %>_name"><%= lab.lab_test_name %></td>
<td id="<%= lab_prefix %>_result"><%= lab.lab_test_result %></td>
<td id="<%= lab_prefix %>_date">
	<%= JSON.stringify(lab.date_measured).substring(1,11) %></td>
</tr>
<% } -%>
</table>

<strong>Gezamenlijke besluitvormingsmodel om betrokkenheid te stimuleren</strong>
<img src="static/sharedDecisionMaking.png" style="max-width:100%;" alt="SDM advies">
<div class="advice_header">Medicatiefactoren</div>

<form id="patient_form">
<%     let medication_advice = patient_advice.medication_advice; -%>
<% for (let i = 0; i < medication_advice.length; ++i ) { -%>
<%     let row = medication_advice[i]; -%>
<%     let atc = row.ATC_code; -%>
<a href="https://en.wikipedia.org/wiki/ATC_code_<%= atc %>">
<%= ucfirst(row.medication_name).trim() %></a>
<div id="advice_<%= atc %>" class="advice_no_checkbox">
<strong>Advies:</strong>
<%     let advices = row.adviceTextsNoCheckboxes; -%>
<%     for (let j = 0; j < advices.length; ++j ) { -%>
<%         let advice = advices[j]; -%>
<%           let att_prefix = "att_" + i + "_" + j; -%>
<%- md.makeHtml(advice.cdss) %>
<%     } -%>
</div>
<p>Maatregelen (aangekruist indien aanbevolen):</p>
<table id="adviceTextsCheckboxesTable_<%= i %>">
<tr><th>criterion</th><th>box</th><th>category</th>
<th>cdss</th><th>epic</th><th>patient</th></tr>
<%     let cb_advices = row.adviceTextsCheckboxes; -%>
<%     for (let j = 0; j < cb_advices.length; ++j ) { -%>
<%         let cb_advice = cb_advices[j]; -%>
<%           let atcbt_prefix = "atcbt_" + i + "_" + j; -%>
<%           let rulenum = cb_advice.medication_criteria_id; -%>
<%           let boxnum = cb_advice.selectBoxNum; -%>
<%           let checkbox_id = `cb_${atc}_${rulenum}_${boxnum}`; -%>
<tr id="<%= atcbt_prefix %>">
<td id="<%= atcbt_prefix %>_mc"><%= cb_advice.medication_criteria_id %></td>
<td id="<%= atcbt_prefix %>_sbn">
<input type="checkbox"
	id="<%= checkbox_id %>"
	name="<%= checkbox_id %>"
	value="<%= checkbox_id %>"
	style="visibility:hidden"
/>
</td>
<td id="<%= atcbt_prefix %>_sbc"><%= cb_advice.selectBoxCategory %></td>
<td id="<%= atcbt_prefix %>_cdss"><%- md.makeHtml(cb_advice.cdss) %></td>
<td id="<%= atcbt_prefix %>_epic"><%- md.makeHtml(cb_advice.epic) %></td>
<td id="<%= atcbt_prefix %>_patient"><%- md.makeHtml(cb_advice.patient) %></td>
</tr>
<%     } -%>
</table>
<% } -%>
</form>
<p>Andere medicatie-gerelateerde advies:</p><!-- TODO add a free text box where the doctor can type in whatever they want. Like other free text boxes, this should be copied to the Epic and Patient text. -->
<div class="advice_header" style="width:20%">Andere risicofactoren</div>
<!-- TODO add non-med advice -->
<p>Andere advies:</p><!-- TODO add a free text box where the doctor can type in whatever they want. Like other free text boxes, this should be copied to the Epic and Patient text. -->
<div class="whitespace"></div>
</body>
</html>
